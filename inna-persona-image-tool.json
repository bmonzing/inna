[
    {
        "id": "inna_persona_image_tool",
        "user_id": "1780e9c3-e0be-4301-bcb2-392c0d9da061",
        "name": "inna_persona_image_tool",
        "content": "import json\nimport random\nfrom datetime import datetime\nfrom pathlib import Path\nfrom typing import Any, Dict, List\n\nimport requests\nfrom pydantic import Field\nfrom pydantic.fields import FieldInfo\n\n\nclass Tools:\n    def __init__(self):\n        pass\n\n    @staticmethod\n    def _resolve_default(value: Any, fallback: Any) -> Any:\n        if isinstance(value, FieldInfo):\n            if value.default not in (None, ...):\n                return value.default\n            factory = value.default_factory\n            if factory is not None and callable(factory):\n                return factory()\n            return fallback\n        return value\n\n    @staticmethod\n    def _coerce_persona(persona: Any) -> Dict[str, Any]:\n        if isinstance(persona, dict):\n            return persona\n        if isinstance(persona, str):\n            persona = persona.strip()\n            if not persona:\n                raise ValueError(\"Persona payload is empty.\")\n            try:\n                data = json.loads(persona)\n            except json.JSONDecodeError as exc:\n                raise ValueError(\"Persona must be valid JSON.\") from exc\n            if not isinstance(data, dict):\n                raise ValueError(\"Persona JSON must decode to an object.\")\n            return data\n        raise TypeError(\"Persona must be provided as a JSON string or dictionary.\")\n\n    @staticmethod\n    def _clean_phrase(value: str, fallback: str) -> str:\n        value = (value or '').strip()\n        if not value:\n            return fallback\n        return value.rstrip('.')\n\n    def _build_workflow(self, persona_data: Dict[str, Any], persona_id: str, output_dir: str, workflow_path: str) -> Dict[str, Any]:\n        name = (\n            persona_data.get(\"name\")\n            or persona_data.get(\"Name\")\n            or \"Unnamed Persona\"\n        )\n        job_title = (\n            persona_data.get(\"job_title\")\n            or persona_data.get(\"Job Title\")\n            or \"Professional\"\n        )\n        quote = (\n            persona_data.get(\"quote\")\n            or persona_data.get(\"pithy_quotation\")\n            or persona_data.get(\"Pithy Quotation\")\n            or \"\"\n        )\n        demographics = (\n            persona_data.get(\"demographics\")\n            or persona_data.get(\"Demographics\")\n            or []\n        )\n        behaviors = (\n            persona_data.get(\"behaviors\")\n            or persona_data.get(\"Behaviors\")\n            or []\n        )\n        needs = (\n            persona_data.get(\"needs\")\n            or persona_data.get(\"needs_and_wants\")\n            or persona_data.get(\"Needs and Wants\")\n            or persona_data.get(\"Needs\")\n            or []\n        )\n\n        clean_phrase = self._clean_phrase\n\n        demographic_phrase = clean_phrase(', '.join(demographics), 'modern professional')\n        posture_phrase = clean_phrase(behaviors[0] if behaviors else '', 'upright posture, attentive hands')\n        gesture_phrase = clean_phrase(behaviors[1] if len(behaviors) > 1 else '', 'confident gesture')\n        expression_phrase = clean_phrase(quote, 'calm focus') if len(quote.split()) <= 8 else 'calm, determined expression'\n        appearance_phrase = clean_phrase(demographics[0] if demographics else '', 'neat appearance')\n        clothing_phrase = f\"work-appropriate {job_title.lower()} attire\"\n\n        tools_phrase = clean_phrase(needs[0] if needs else '', 'laptop and organized notebook')\n        wall_phrase = clean_phrase(needs[1] if len(needs) > 1 else '', 'strategy sketches')\n        personal_phrase = clean_phrase(needs[2] if len(needs) > 2 else '', 'succulent plant')\n\n        positive_raw = (\n            f\"{name}, {job_title}, seated at a desk; \"\n            f\"{posture_phrase}; {expression_phrase}; {appearance_phrase}; {clothing_phrase}. \"\n            f\"Minimal workspace with {tools_phrase}; wall hints ({wall_phrase}); {personal_phrase}.\"\n        )\n        positive_words = positive_raw.split()\n        if len(positive_words) > 80:\n            positive_raw = ' '.join(positive_words[:80])\n\n        notes = (\n            f\"{name.split()[0] if name else 'Persona'} sits slightly angled with {posture_phrase} and {gesture_phrase}. \"\n            f\"Expression stays {expression_phrase.lower()} to match their approach. \"\n            f\"Environment stays secondary: {tools_phrase}, wall hints of {wall_phrase}, and {personal_phrase} drawn lightly.\"\n        )\n\n        render = {\n            'width': 1024,\n            'height': 1024,\n            'steps': 24,\n            'cfg': 5,\n            'seed': random.randint(10 ** 5, 10 ** 12),\n        }\n\n        workflow_file = Path(workflow_path)\n        if not workflow_file.exists():\n            raise FileNotFoundError(f\"Workflow not found at {workflow_path}\")\n        workflow = json.loads(workflow_file.read_text(encoding='utf-8'))\n\n        prompt_template = workflow.get('10', {}).get('inputs', {}).get('text')\n        if not isinstance(prompt_template, str):\n            raise ValueError(\"Workflow missing expected prompt text at node '10'.\")\n\n        prompt_filled = (\n            prompt_template.replace('[Name]', name)\n            .replace('[Job Title]', job_title)\n            .replace('[posture and gesture]', posture_phrase)\n            .replace('[expression]', expression_phrase)\n            .replace('[appearance]', appearance_phrase)\n            .replace('[clothing]', clothing_phrase)\n            .replace('[work tools]', tools_phrase)\n            .replace('[wall artifacts]', wall_phrase)\n            .replace('[personal touches]', personal_phrase)\n        )\n\n        workflow['10']['inputs']['text'] = prompt_filled\n        workflow['12']['inputs']['seed'] = render['seed']\n        workflow['12']['inputs']['steps'] = render['steps']\n        workflow['12']['inputs']['cfg'] = render['cfg']\n\n        output_path = Path(output_dir).expanduser()\n        output_path.mkdir(parents=True, exist_ok=True)\n        filename_prefix = str(output_path / persona_id)\n        workflow['17']['inputs']['filename_prefix'] = filename_prefix\n\n        payload = {\n            'prompt': workflow,\n            'client_id': f\"inna-{persona_id}-{datetime.utcnow().timestamp()}\"\n        }\n\n        result = {\n            'persona_id': persona_id,\n            'positive_persona': positive_raw,\n            'notes_explanation': notes,\n            'render': render,\n            'workflow_submitted': False,\n            'output_prefix': filename_prefix,\n        }\n\n        return payload, result\n\n    @staticmethod\n    def _submit_prompt(comfy_base_url: str, payload: Dict[str, Any]) -> Dict[str, Any]:\n        try:\n            response = requests.post(\n                f\"{comfy_base_url.rstrip('/')}/prompt\",\n                json=payload,\n                timeout=30,\n            )\n            response.raise_for_status()\n        except requests.RequestException as exc:\n            raise RuntimeError(f\"ComfyUI prompt submission failed: {exc}\") from exc\n\n        try:\n            return response.json()\n        except ValueError:\n            return {\"raw\": response.text[:200]}\n\n    def _generate_single(\n        self,\n        persona_data: Dict[str, Any],\n        persona_id: str,\n        output_dir: str,\n        workflow_path: str,\n        comfy_base_url: str,\n    ) -> Dict[str, Any]:\n        payload, result = self._build_workflow(persona_data, persona_id, output_dir, workflow_path)\n        comfy_ack = self._submit_prompt(comfy_base_url, payload)\n        result['workflow_submitted'] = True\n        result['comfy_response'] = comfy_ack\n        return result\n\n    def generate_persona_line_art(\n        self,\n        persona: str = Field(..., description=\"Proto-persona JSON string produced by Inna Step 3.\"),\n        persona_id: str = Field(..., description=\"Slug used for file names, e.g. 'ops_director'.\"),\n        output_dir: str = Field(\"~/comfyui/output/persona_images\", description=\"Directory (inside ComfyUI's output tree) where generated images are saved.\"),\n        workflow_path: str = Field(\"/Users/287096/inna/line-art.json\", description=\"Path to the ComfyUI workflow JSON template.\"),\n        comfy_base_url: str = Field(\"http://127.0.0.1:8188\", description=\"Base URL for the local ComfyUI instance.\"),\n    ) -> str:\n        persona_data = self._coerce_persona(persona)\n\n        default_output_dir = str(Path.home() / \"comfyui\" / \"output\" / \"persona_images\")\n        output_dir = self._resolve_default(output_dir, default_output_dir)\n        workflow_path = self._resolve_default(workflow_path, \"/Users/287096/inna/line-art.json\")\n        comfy_base_url = self._resolve_default(comfy_base_url, \"http://127.0.0.1:8188\")\n\n        result = self._generate_single(persona_data, persona_id, output_dir, workflow_path, comfy_base_url)\n        return json.dumps(result, ensure_ascii=False)\n\n    def generate_persona_line_art_batch(\n        self,\n        personas: List[Dict[str, Any]] = Field(\n            ..., description=\"List of entries, each containing 'persona' (JSON string or dict) and 'persona_id' (slug).\"\n        ),\n        output_dir: str = Field(\"~/comfyui/output/persona_images\", description=\"Directory (inside ComfyUI's output tree) where generated images are saved.\"),\n        workflow_path: str = Field(\"/Users/287096/inna/line-art.json\", description=\"Path to the ComfyUI workflow JSON template.\"),\n        comfy_base_url: str = Field(\"http://127.0.0.1:8188\", description=\"Base URL for the local ComfyUI instance.\"),\n    ) -> str:\n        default_output_dir = str(Path.home() / \"comfyui\" / \"output\" / \"persona_images\")\n        output_dir = self._resolve_default(output_dir, default_output_dir)\n        workflow_path = self._resolve_default(workflow_path, \"/Users/287096/inna/line-art.json\")\n        comfy_base_url = self._resolve_default(comfy_base_url, \"http://127.0.0.1:8188\")\n\n        results: List[Dict[str, Any]] = []\n        for index, entry in enumerate(personas):\n            if not isinstance(entry, dict):\n                results.append({\n                    'status': 'error',\n                    'persona_id': f'entry_{index}',\n                    'workflow_submitted': False,\n                    'error': 'Each item must be a dictionary with keys \"persona\" and \"persona_id\".'\n                })\n                continue\n\n            persona_payload = entry.get('persona')\n            persona_id = entry.get('persona_id')\n\n            if persona_payload is None or not persona_id:\n                results.append({\n                    'status': 'error',\n                    'persona_id': entry.get('persona_id', f'entry_{index}'),\n                    'workflow_submitted': False,\n                    'error': 'Each entry must include both \"persona\" and \"persona_id\".'\n                })\n                continue\n\n            try:\n                persona_data = self._coerce_persona(persona_payload)\n                single_result = self._generate_single(persona_data, persona_id, output_dir, workflow_path, comfy_base_url)\n                single_result['status'] = 'success'\n                results.append(single_result)\n            except Exception as exc:\n                results.append({\n                    'status': 'error',\n                    'persona_id': persona_id,\n                    'workflow_submitted': False,\n                    'error': str(exc),\n                })\n\n        summary = {\n            'requested': len(personas),\n            'succeeded': sum(1 for item in results if item.get('status') == 'success'),\n            'failed': sum(1 for item in results if item.get('status') == 'error'),\n            'results': results,\n        }\n\n        return json.dumps(summary, ensure_ascii=False)\n",
        "specs": [
            {
                "name": "generate_persona_line_art",
                "description": "Generate a persona line-art image using ComfyUI with the line-art workflow.",
                "parameters": {
                    "type": "object",
                    "properties": {
                        "persona": {
                            "type": "string",
                            "description": "Proto-persona JSON string produced by Inna Step 3."
                        },
                        "persona_id": {
                            "type": "string",
                            "description": "Slug used for file names, e.g. 'ops_director'."
                        },
                        "output_dir": {
                            "type": "string",
                            "description": "Directory (inside ComfyUI's output tree) where generated images are saved.",
                            "default": "~/comfyui/output/persona_images"
                        },
                        "workflow_path": {
                            "type": "string",
                            "description": "Path to the ComfyUI workflow JSON template.",
                            "default": "/Users/287096/inna/line-art.json"
                        },
                        "comfy_base_url": {
                            "type": "string",
                            "description": "Base URL for the local ComfyUI instance.",
                            "default": "http://127.0.0.1:8188"
                        }
                    },
                    "required": [
                        "persona",
                        "persona_id"
                    ],
                    "additionalProperties": false
                }
            },
            {
                "name": "generate_persona_line_art_batch",
                "description": "Generate persona line-art images for multiple personas using a single ComfyUI submission per persona.",
                "parameters": {
                    "type": "object",
                    "properties": {
                        "personas": {
                            "type": "array",
                            "description": "List of entries, each containing 'persona' (JSON string or dict) and 'persona_id' (slug).",
                            "items": {
                                "type": "object",
                                "properties": {
                                    "persona": {
                                        "description": "Proto-persona JSON string produced by Inna Step 3.",
                                        "type": "string"
                                    },
                                    "persona_id": {
                                        "description": "Slug used for file names, e.g. 'ops_director'.",
                                        "type": "string"
                                    }
                                },
                                "required": [
                                    "persona",
                                    "persona_id"
                                ],
                                "additionalProperties": true
                            }
                        },
                        "output_dir": {
                            "type": "string",
                            "description": "Directory (inside ComfyUI's output tree) where generated images are saved.",
                            "default": "~/comfyui/output/persona_images"
                        },
                        "workflow_path": {
                            "type": "string",
                            "description": "Path to the ComfyUI workflow JSON template.",
                            "default": "/Users/287096/inna/line-art.json"
                        },
                        "comfy_base_url": {
                            "type": "string",
                            "description": "Base URL for the local ComfyUI instance.",
                            "default": "http://127.0.0.1:8188"
                        }
                    },
                    "required": [
                        "personas"
                    ],
                    "additionalProperties": false
                }
            }
        ],
        "meta": {
            "description": "Generate persona-driven line art via ComfyUI",
            "manifest": {}
        },
        "access_control": {},
        "updated_at": 1761113600,
        "created_at": 1761113600
    }
]
